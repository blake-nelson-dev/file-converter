rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // PERMANENT USER FILES
    // Path structure: /files/{userId}/...
    // Example: /files/abc123/documents/resume.pdf
    // - Only the file owner can read/write their files
    // - Files persist indefinitely until user deletes them
    // - Each file should have a corresponding Firestore document with metadata
    match /files/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // TEMPORARY CONVERSION FILES
    // Path structure: /temp/{userId}-{uuid}/...
    // Example: /temp/abc123-550e8400-e29b-41d4-a716-446655440000/input.pdf
    //          /temp/abc123-550e8400-e29b-41d4-a716-446655440000/output.docx
    // 
    // Security explanation:
    // - {userSessionFolder} must start with the authenticated user's ID
    // - Format enforced: "{userId}-{uuid v4}"
    // - UUID v4 provides cryptographically secure randomness (unguessable)
    // - This prevents users from accessing other users' temporary files
    // - Files in these folders are auto-deleted after 1 hour by a scheduled Cloud Function
    //
    // Why this approach:
    // - Secure: UUID v4 has 2^122 possible values (impossible to guess)
    // - User isolation: Each user can only access their own folders
    // - Clear separation from permanent storage
    // - Users who don't want to save data can use temp-only conversion
    match /temp/{userSessionFolder}/{allPaths=**} {
      allow read, write: if request.auth != null 
        && userSessionFolder.matches(request.auth.uid + '-[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12}');
    }
    
    // DEFAULT DENY RULE
    // Any path not explicitly matched above is denied access
    // This is a security best practice - fail closed, not open
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
