rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // PERMANENT USER FILES
    // Path structure: /files/{userId}/...
    // Example: /files/abc123/documents/resume.pdf
    // - Only the file owner can read/write their files
    // - Files persist indefinitely until user deletes them
    // - Each file should have a corresponding Firestore document with metadata
    match /files/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // TEMPORARY CONVERSION FILES (ANONYMOUS)
    // Path structure: /temp/{uuid}/...
    // Example: /temp/550e8400-e29b-41d4-a716-446655440000/input.pdf
    //          /temp/550e8400-e29b-41d4-a716-446655440000/output.docx
    // 
    // Security & Privacy:
    // - Fully anonymous - no user ID in path
    // - Only requirement: user must be authenticated
    // - UUID v4 provides cryptographically secure randomness (unguessable)
    // - No tracking of who uploaded what
    // - Files are auto-deleted after 1 hour by a scheduled Cloud Function
    //
    // Why this approach:
    // - Maximum privacy: No user association with temporary files
    // - Secure: UUID v4 has 2^122 possible values (impossible to guess)
    // - GDPR/CCPA friendly: No personal data stored
    // - Perfect for users who want anonymous file conversion
    match /temp/{uuidFolder}/{allPaths=**} {
      allow read, write: if request.auth != null 
        && uuidFolder.matches('[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12}');
    }
    
    // DEFAULT DENY RULE
    // Any path not explicitly matched above is denied access
    // This is a security best practice - fail closed, not open
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
